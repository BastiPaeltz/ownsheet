"use strict";function readFile(e,o,t){var r=new FileReader;r.onload=t;try{r.readAsText(e)}catch(n){o.alerts.push({type:"danger",msg:"Can't read import file."}),o.closeAlert=function(e){o.alerts.splice(e,1)}}}function validateAndCheckForDuplicates(e,o,t,r){function n(e){return e===s[e].name&&2===Object.getOwnPropertyNames(s[e]).length&&s[e].content}var c,s;try{s=JSON.parse(e)}catch(l){t.alerts.push({type:"danger",msg:"Couldn't parse input file. Make sure this is the ownsheet-content.json file you exported earlier."}),t.closeAlert=function(e){t.alerts.splice(e,1)}}c=o.getFromStorage(null),c.then(function(e){var c,l=[],a=0,i=0,d=0;Object.keys(s).forEach(function(t){if(n(t))if(i+=1,e[t])e[t].content!==s[t].content?l.push(s[t]):a+=1;else{var r={};r[t]=s[t],o.pushToStorage(r),a+=1}else d+=1,delete s[t]}),c={conflicts:l,failed:d,safe:a,total:i},startImportDialog(c,t,r,o)})}function startImportDialog(e,o,t,r){0===e.conflicts.length?printSuccessBootBox(e):printAndProcessBootBox(e,0,t,r)}function printAndProcessBootBox(e,o,t,r){if(o<e.conflicts.length){var n=bootBoxDialog(e,o,t);n.then(function(n){switch(n){case"skip":o+=1,printAndProcessBootBox(e,o,t,r);break;case"override":var c={};c[e.conflicts[o].name]=e.conflicts[o],r.pushToStorage(c),o+=1,e.safe+=1,printAndProcessBootBox(e,o,t,r);break;case"override-all":for(var c={},s=o;s<e.conflicts.length;s++)e.safe+=1,c[e.conflicts[o].name]=e.conflicts[o],r.pushToStorage(c);printSuccessBootBox(e)}})}else printSuccessBootBox(e)}function bootBoxDialog(e,o,t){var r=t.defer();return bootbox.dialog({message:"Detected "+e.failed+" invalid sheet. "+e.safe+" out of "+e.total+" valid sheets were successfully imported. Conflicts on "+(e.conflicts.length-o)+" remaining sheets. <br/><br/> Conflict on sheet <b>'"+e.conflicts[o].name+"'</b>",title:"Import into ownsheet",buttons:{success:{label:"Keep",className:"btn-success",callback:function(){r.resolve("skip")}},main:{label:"Override",className:"btn-primary",callback:function(){r.resolve("override")}},danger:{label:"Override all",className:"btn-danger",callback:function(){r.resolve("override-all")}}}}),r.promise}function printSuccessBootBox(e){bootbox.alert("Detected "+e.failed+" invalid sheet. "+e.safe+" out of "+e.total+" valid sheets were successfully imported. No remaining conflicts.<br/><br/> <b>Import completed!</b>")}var ownsheetApp=angular.module("ownsheetApp");ownsheetApp.controller("generalController",["$scope","$window","$q","chromeStorageService","localStorageService",function(e,o,t,r,n){e.colors=n.get("colors")||[{code:"#2d9f34"},{code:"#4b65c3"},{code:"#48456a"},{code:"#4f7a4e"},{code:"#d61115"},{code:"#59582f"}],e.backgroundColor=n.get("background-color")||"#b3b3b3",e.boxSize=n.get("box-size")||250,e.alerts=[],document.title="Explore ownsheet",n.isSupported||(e.warning="Your browser doesn't seem to support HTML5 local storage! Please update your browser, if you want to customize ownsheet."),e.converter="## headings will be converted. \nYou can convert headings UP or DOWN.\n\n### Subheadings will be converted up to level 4.\n\n### You can test it with this example text.\n\nAny content will stay the same.\n",this.addFont=function(){e.colors.push({code:""})},this.removeFont=function(){e.colors.pop(),e.colors.length<1&&(e.colors=[{code:"#2d9f34"},{code:"#4b65c3"},{code:"#48456a"},{code:"#4f7a4e"},{code:"#d61115"},{code:"#59582f"}])},this.submitFonts=function(){for(var o in e.colors)/^#[0-9A-F]{6}$/i.test(e.colors[o].code)===!1&&e.colors.splice(o,1);e.colors.length<1?(e.colors=[{code:"#2d9f34"},{code:"#4b65c3"},{code:"#48456a"},{code:"#4f7a4e"},{code:"#d61115"},{code:"#59582f"}],bootbox.alert("Please enter valid hex color codes!")):(n.set("colors",e.colors),bootbox.alert(e.colors.length+" custom colors saved!"))},this.resetFonts=function(){e.colors=[{code:"#2d9f34"},{code:"#4b65c3"},{code:"#48456a"},{code:"#4f7a4e"},{code:"#d61115"},{code:"#59582f"}],n.set("colors",e.colors),bootbox.alert("Box colors reset!")},this.convertUp=function(){e.converter=e.converter.replace(/(\n|^)[\#]{3}([^\#])/g,"$1####$2"),e.converter=e.converter.replace(/(\n|^)[\#]{2}([^\#])/g,"$1###$2"),e.converter=e.converter.replace(/(\n|^)[\#]{1}([^\#])/g,"$1##$2")},this.convertDown=function(){e.converter=e.converter.replace(/(\n|^)[\#]{2}([^\#])/g,"$1#$2"),e.converter=e.converter.replace(/(\n|^)[\#]{3}([^\#])/g,"$1##$2"),e.converter=e.converter.replace(/(\n|^)[\#]{4}([^\#])/g,"$1###$2")},this.submitBGColor=function(){/^#[0-9A-F]{6}$/i.test(e.backgroundColor)===!1?(e.backgroundColor="#b3b3b3",bootbox.alert("Please enter valid hex color codes!")):(n.set("background-color",e.backgroundColor),bootbox.alert("Background color saved!"))},this.resetBGColor=function(){e.backgroundColor="#b3b3b3",n.set("background-color",e.backgroundColor),bootbox.alert("Background color reset!")},this.submitBoxSize=function(){$.isNumeric(e.boxSize)&&e.boxSize>100&&e.boxSize<700?(n.set("box-size",e.boxSize),bootbox.alert("Box size saved!")):(e.boxSize=250,bootbox.alert("Please enter an integer number between 100 and 700."))},this.resetBoxSize=function(){e.boxSize=250,n.set("box-size",e.boxSize),bootbox.alert("Box size reset!")},this["import"]=function(){readFile(document.getElementById("importFile").files[0],e,function(o){validateAndCheckForDuplicates(o.target.result,r,e,t)})},this["export"]=function(){var e=r.getFromStorage(null);e.then(function(e){var o=new Blob([JSON.stringify(e)],{type:"application/json;charset=utf-8"});saveAs(o,"ownsheet-content.json")})}}]);